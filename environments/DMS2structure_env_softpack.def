Bootstrap: docker
From: mercury/softpack-build:0.21.1.1
Stage: build

%files
	/home/ubuntu/.aws /root/.aws
	/home/ubuntu/spack/opt/spack/gpg /opt/spack/opt/spack/gpg

%post
	# Create the manifest file for the installation in /opt/spack-environment
	mkdir /opt/spack-environment && cd /opt/spack-environment
	cat << EOF > spack.yaml
spack:
  # add package specs to the specs list
  specs:
  - r-cowplot@1.1.3 arch=None-None-x86_64_v3
  - r-rpdb@2.3.4 arch=None-None-x86_64_v3
  - r-catools@1.18.2 arch=None-None-x86_64_v3
  - r-mgcv@1.9-1 arch=None-None-x86_64_v3
  - r-ggally@2.2.1 arch=None-None-x86_64_v3
  - r-pdist@1.2.1 arch=None-None-x86_64_v3
  - r-gdata@3.0.0 arch=None-None-x86_64_v3
  - r-stringr@1.5.1 arch=None-None-x86_64_v3
  - r-ggplot2@3.5.0 arch=None-None-x86_64_v3
  - r-rcolorbrewer@1.1-3 arch=None-None-x86_64_v3
  - r-seqinr@4.2-36 arch=None-None-x86_64_v3
  - r-pheatmap@1.0.12 arch=None-None-x86_64_v3
  - r-data-table@1.15.4 arch=None-None-x86_64_v3
  - r-corpcor@1.6.10 arch=None-None-x86_64_v3
  - r-optparse@1.7.4 arch=None-None-x86_64_v3
  - r-metap@1.9 arch=None-None-x86_64_v3
  - xplor-nih@3.8 arch=None-None-x86_64_v3
  - tmscore@2022-02-27 arch=None-None-x86_64_v3
  view: /opt/view
  concretizer:
    unify: true
  config:
    install_tree: /opt/software
EOF

	# Install all the required software
	. /opt/spack/share/spack/setup-env.sh
	tmpDir="$(mktemp -d)"
	git clone "https://github.com/wtsi-hgi/spack-repo.git" "$tmpDir"
	git -C "$tmpDir" checkout "acd2ba5fe1fb1c6f3d39a658ac8191c0d7028b20"
	spack repo add "$tmpDir"
	spack config add "config:install_tree:padded_length:128"
	spack -e . concretize
	spack mirror add s3cache "s3://spack"
	spack buildcache keys --install --trust
	if bash -c "type -P xvfb-run" > /dev/null; then
		xvfb-run -a spack -e . install --fail-fast
	else
		spack -e . install --fail-fast
	fi || {
		spack -e . buildcache push -a s3cache
		false
	}
	spack -e . buildcache push -a s3cache || true
	spack gc -y
	spack env activate --sh -d . >> /opt/spack-environment/environment_modifications.sh

	# Strip the binaries to reduce the size of the image
	find -L /opt/view/* -type f -exec readlink -f '{}' \; | \
	xargs file -i | \
	grep 'charset=binary' | \
	grep 'x-executable\|x-archive\|x-sharedlib' | \
	awk -F: '{print $1}' | xargs strip || true

	exes="$(find $(grep "^export PATH=" /opt/spack-environment/environment_modifications.sh | sed -e 's/^export PATH=//' -e 's/;$//' | tr ":" "\n" | grep /opt/view | tr "\n" " ") -maxdepth 1 -executable -type l | xargs -r -L 1 readlink)"
	{
		for pkg in "r-cowplot" "r-rpdb" "r-catools" "r-mgcv" "r-ggally" "r-pdist" "r-gdata" "r-stringr" "r-ggplot2" "r-rcolorbrewer" "r-seqinr" "r-pheatmap" "r-data-table" "r-corpcor" "r-optparse" "r-metap" "xplor-nih" "tmscore"; do
			echo "$exes" | grep "/linux-[^/]*/gcc-[^/]*/$pkg-" || true
		done | xargs -L 1 -r basename
		echo "R"
		echo "Rscript"
		find /opt/view/bin/ -maxdepth 1 -type f -executable | xargs -r -L 1 basename
	} | sort | uniq > executables

Bootstrap: docker
From: mercury/softpack-final:22.04
Stage: final

%files from build
	/opt/spack-environment /opt
	/opt/software /opt
	/opt/._view /opt
	/opt/view /opt
	/opt/spack-environment/environment_modifications.sh /opt/spack-environment/environment_modifications.sh

%post
	# Modify the environment without relying on sourcing shell specific files at startup
	cat /opt/spack-environment/environment_modifications.sh >> $SINGULARITY_ENVIRONMENT
